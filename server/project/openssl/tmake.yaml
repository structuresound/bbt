git:
  repository: openssl/openssl
  tag: OpenSSL_1_0_2h
OPENSSL_VERSION: 1.0.2h
DEVELOPER: "$(xcode-select -print-path)"
mac:
  PLATFORM: darwin64-x86_64-cc
  OSX_DEPLOYMENT_VERSION: '10.8'
  OSX_SDK_VERSION: "$(xcrun --sdk macosx --show-sdk-version)"
  OSX_PLATFORM: "$(xcrun --sdk macosx --show-sdk-platform-path)"
  OSX_SDK: "$(xcrun --sdk macosx --show-sdk-path)"
"mac, linux":
  ARCH: x86_64
ios:
  ARCH: arm64
  SDK_VERSION: "$(xcrun --sdk iphoneos --show-sdk-version)"
  CROSS_TOP: "{DEVELOPER}/Platforms/iPhoneOS.platform/Developer"
  CROSS_SDK: iPhoneOS{SDK_VERSION}.sdk
  IPHONEOS_DEPLOYMENT_VERSION: '6.0'
  IPHONEOS_SDK_VERSION: "$(xcrun --sdk iphoneos --show-sdk-version)"
  IPHONEOS_PLATFORM: "$(xcrun --sdk iphoneos --show-sdk-platform-path)"
  IPHONEOS_SDK: "$(xcrun --sdk iphoneos --show-sdk-path)"
configure:
  "ios, mac, linux":
    bignum: sed -ie "s/BIGNUM \*I,/BIGNUM \*i,/g" crypto/rsa/rsa.h
  mac:
    configure:
    - ./Configure {PLATFORM} --openssldir="{d.build}/openssl-{OPENSSL_VERSION}-{ARCH}"
    - sed -ie "s!^CFLAG=!CFLAG=-isysroot {OSX_SDK} -arch {ARCH} -mmacosx-version-min={OSX_DEPLOYMENT_VERSION}!" "Makefile"
  linux:
    configure:
    - ./config enable-tlsext no-shared no-zlib -fPIC no-gost --openssldir="{d.build}/openssl-{OPENSSL_VERSION}-{ARCH}"
    - make depend
  ios:
    configure:
    - ./Configure iphoneos-cross -no-asm --openssldir="/tmp/openssl-{OPENSSL_VERSION}-{ARCH}"
    - perl -i -pe 's|static volatile sig_atomic_t intr_signal|static volatile int intr_signal|' crypto/ui/ui_openssl.c
    replace:
      files:
        matching:
        - Makefile
        inputs:
          "-isysroot $(CROSS_TOP)/SDKs/$(CROSS_SDK)": "-isysroot {CROSS_TOP}/SDKs/{CROSS_SDK}
            -miphoneos-version-min={SDK_VERSION}"
build:
  shell:
  - make -j{host.cpu.num}
  ios:
    shell:
    - CC="{DEVELOPER}/usr/bin/gcc -fembed-bitcode -arch {ARCH}" make -j{host.cpu.num}
path:
  project: source
  install:
    headers:
      from: source/include/openssl
      to: include/openssl
    libraries:
      from: source
      to: lib

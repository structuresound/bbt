git:
  repository: openssl/openssl
  tag: OpenSSL_1_0_2h
environment:
  OPENSSL_VERSION: 1.0.2h
  DEVELOPER: "$(xcode-select -print-path)"
  x64:
    OPENSSL_ARCH: x86_64
configure:
  shell:
    bignum: sed -ie "s/BIGNUM \*I,/BIGNUM \*i,/g" crypto/rsa/rsa.h
  make:
    arguments: ${parent.target.flags.compiler.target}
    flags:
      openssldir: ${d.build}/openssl-${OPENSSL_VERSION}  
    arguments:
      =linux:
        enable-tlsext: 1
        no-shared: 1
        no-zlib: 1
        -fPIC: 1
        no-gost: 1
      =ios:
        iphoneos-cross: 1
        -no-asm: 1
  +ios:
    replace:
        files:
          matching:
          - Makefile
          inputs:
            "-isysroot $(CROSS_TOP)/SDKs/$(CROSS_SDK)": "-isysroot ${CROSS_TOP}/SDKs/${CROSS_SDK} -miphoneos-version-min=${SDK_VERSION}"
    shell:
      perl: perl -i -pe 's|static volatile sig_atomic_t intr_signal|static volatile int intr_signal|' crypto/ui/ui_openssl.c
build:
  make:
    =ios:
      prefix: CC="${DEVELOPER}/usr/bin/gcc -fembed-bitcode -arch ${OPENSSL_ARCH}"
path:
  project: source
  install:
    headers:
      from: source/include/openssl
      to: include/openssl
    libraries:
      from: source
